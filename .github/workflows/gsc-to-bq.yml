name: ðŸš€ GSC to BigQuery - Incremental Daily Sync

on:
  workflow_dispatch:  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  schedule:
    - cron: "0 3 * * *"  # Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 03:00 UTC (Ù…Ø«Ù„Ø§Ù‹ 6:30 ØµØ¨Ø­ Ø§ÛŒØ±Ø§Ù†)

jobs:
  sync-gsc-to-bq:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-cloud-bigquery google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client pandas pyarrow db-dtypes

      - name: ðŸ”‘ Write GCP credentials
        if: ${{ secrets.BAMTABRIDSAZAN_GCP_SA_KEY_BASE64 != '' }}
        run: |
          echo "WROTE: gcp-key.json from BAMTABRIDSAZAN_GCP_SA_KEY_BASE64"
          echo "${{ secrets.BAMTABRIDSAZAN_GCP_SA_KEY_BASE64 }}" | base64 --decode > gcp-key.json
          echo "gcp-key.json size: $(wc -c < gcp-key.json)"

      - name: âœ… Validate credentials file
        run: |
          python -c "import json; json.load(open('gcp-key.json')); print('âœ… gcp-key.json is valid')"

      - name: ðŸš€ Running incremental GSC sync...
        run: |
          echo "ðŸš€ Running incremental GSC sync..."
          python gsc_to_bq.py
